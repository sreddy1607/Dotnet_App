stage('MotioCI login → token') {
      steps {
        container('python') {
        sh '''
          set -eu
          cd MotioCI/api/CLI

          TOKEN=""
          if [ -n "${COGNOS_API_KEY}" ]; then
            echo "Login via PRD CAMPassport..."
            TOKEN="$(python3 ci-cli.py --server="https://cgrptmcip01.cloud.cammis.ca.gov" --non-interactive \
                     login --camPassportId "${COGNOS_API_KEY}")" || true
          fi

          if [ -z "${TOKEN}" ] && [ -n "ldapadmin" ] && [ -n "G0RL0uCwP4nIWrs8" ]; then
            echo "Login via PRD username/password..."
            TOKEN="$(python3 ci-cli.py --server="https://cgrptmcip01.cloud.cammis.ca.gov" --non-interactive \
                     login --username "ldapadmin" --password "G0RL0uCwP4nIWrs8" --namespaceId "LDAP")" || true
          fi

          test -n "${TOKEN}" || { echo "ERROR: MotioCI login failed."; exit 1; }
          printf "%s" "${TOKEN}" > .motio_token
          echo "Saved token → $(pwd)/.motio_token"
        '''
        }
      }
    }
