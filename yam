container(name: "dotnet") {
          lock(resource: 'deployments-github-repo',inversePrecedence: false ) {
           dir("${WORKSPACE}/deployrepo"){
              withCredentials([usernamePassword(credentialsId: "github-key", usernameVariable: 'NUSER', passwordVariable: 'NPASS')]) {
                
                sh """
                  # Clone tar-surge-client-deployment repo
		              git clone https://${NUSER}:${NPASS}@github.com/ca-mmis/tar-surge-client-deployment.git --depth=1
		              cd tar-surge-client-deployment
		              git checkout master
		              git pull
	              
		              mkdir -p ${WORKSPACE}/deployrepo/tar-surge-client-deployment/tar-surge-client/SurgeAutoupdate

					  echo "Removing BAT script from SurgeUpdate before zipping..."
					  rm -f ${WORKSPACE}/devops/codedeploy/SurgeUpdate/SurgeInstall_${env_deploy_env}.bat || true
					  rm -f ${WORKSPACE}/devops/codedeploy/SurgeUpdate/SurgeUpdate_${env_deploy_env}.ZIP	
					  echo "Recreating ZIP again without BAT script..."

					  cd ${WORKSPACE}/devops/codedeploy
					  zip -r SurgeUpdate/SurgeUpdate_${env_deploy_env}.ZIP SurgeUpdate
						
						
					  echo "Copying ZIP and BAT script separately..."
					  cd ${WORKSPACE}/deployrepo/tar-surge-client-deployment
		              
		              cp ${WORKSPACE}/devops/codedeploy/SurgeUpdate/SurgeUpdate_${env_deploy_env}.ZIP tar-surge-client/SurgeAutoupdate
		              cp ${WORKSPACE}/Config/${env_deploy_env}/SurgeInstall_${env_deploy_env}.bat tar-surge-client/SurgeAutoupdate
		
		              # Commit and push changes
		              if [[ -n \$(git status --porcelain) ]]; then
		                git add .
		                git commit -m "Automated commit - Deploying SurgeUpdate artifacts"
		                git push origin master
		              fi
		
		              # Tag this deployment
		              git tag -f -a "${env_tag_name}" -m "Deploying Thickclient - Tag ${env_tag_name}"
		              git push origin "${env_tag_name}" --force
					  
                """
