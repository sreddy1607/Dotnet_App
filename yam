stage("initialize") {
      steps {
        container(name: "node") {
          script {
            properties([
              parameters([
                  [
                    $class: 'ChoiceParameter',
                    choiceType: 'PT_SINGLE_SELECT',
                    // filterLength: 1,
                    // filterable: false,
                    name: 'SOURCE_BRANCHNAME',
                    script: [
                        $class: 'GroovyScript',
                        fallbackScript: [
                            classpath: [],
                            sandbox: true,
                            script:
                                "return ['error']"
                        ],
                        script: [
                            classpath: [],
                            sandbox: true,
                            script: """
                                return["${env.BRANCH_NAME}"]
                            """
                        ]
                    ]
                  ],
                  [   $class: 'ChoiceParameter',
                      choiceType: 'PT_SINGLE_SELECT',
                      name: 'TARGET_ENVIRONMENT',
                      script: [
                          $class: 'GroovyScript',
                          fallbackScript: [
                              classpath: [],
                              sandbox: true,
                              script:
                                  "return['Could not get the environments']"
                          ],
                          script: [
                              classpath: [],
                              sandbox: true,
                              script: """
                                 if ('${env.BRANCH_NAME}'.contains('sandbox')){
                                     return['sandbox:selected']
                                    }
                                 else if('${env.BRANCH_NAME}'.contains('master')){
                                     return['dev:selected']
                                    }
                                """
                          ]
                      ]
                  ],
                  [     $class: 'ChoiceParameter',
                        choiceType: 'PT_CHECKBOX',
                        name: 'OPENSHIFT_NAMESPACES',
                        script:
                            [$class: 'GroovyScript',
                            fallbackScript: [
                                    classpath: [],
                                    sandbox: true,
                                    script:
                                        "return['Could not get The namespaces']"
                                    ],
                            script: [
                                    classpath: [],
                                    sandbox: true,
                                    script: """
                                        if ('${env.BRANCH_NAME}'.contains('sandbox')){
                                            return['${env.BRANCH_NAME}:selected']
                                            }
                                        else if('${env.BRANCH_NAME}'.equals('master')){
                                            return['dev:selected']
                                            }
                                        """
                              ]
                      ]
                  ],
                choice(name: 'RELEASE_TYPE', choices: ['PATCH','MINOR','MAJOR'], description: 'Enter Release type'),
                booleanParam(name: 'USE_GIT_TAG', defaultValue: false, description: 'Use the selected git tag instead of LATEST commit'),
                gitParameter(name: 'GIT_TAG', defaultValue: 'provider-portal-app_deployed_in_dev_dev_from_master', description: 'git tag', type: 'PT_TAG', sortMode: 'DESCENDING_SMART'),
                string(name: 'RELEASE',defaultValue: 'enter release name (Release-1.2.3)', description: 'Enter release name (overrides default config)'),
                string(name: 'GIT_SHA',defaultValue: 'enter git sha(8+ chars)', description: 'enter git sha that you want to deploy')
              ])
            ])

            env_stage_name = "initialize"
            env_step_name = "checkout"

            deleteDir()

            echo 'checkout source  and get the commit id'
            env_current_git_commit = checkout(scm).GIT_COMMIT

            //env_git_repo_url = sh(returnStdout: true, script: 'git config remote.origin.url').trim()
            env_git_repo_url = scm.userRemoteConfigs[0].url
            echo "Git repo URL: ${env_git_repo_url}"
            echo 'Loading properties file'
            env_step_name = "load properties"
            // load the pipeline properties
            load("devops/jenkins/Jenkinsfile.properties")

            echo "The cluster subdomain is ${env_cluster_subdomain}"

            env_step_name = "set global variables"
            echo 'initialize slack channels and tokens'
            initSlackChannels()

            echo 'set branch name'
			      echo 'BRANCH_NAME: --- ${BRANCH_NAME}'
            env_git_branch_name = BRANCH_NAME
            echo 'Source branch'
            echo params.SOURCE_BRANCHNAME
            echo 'Target enviroment'
            echo params.TARGET_ENVIRONMENT
            echo 'openshift namespaces'
            echo params.OPENSHIFT_NAMESPACES

            echo ' capture the selected jenkins node and use it for every thing in the pipeline'
            env_selected_jenkins_node=NODE_NAME

            env_git_tag_name = params.GIT_TAG

            // override PO acceptance of build
            // by default, PO always checks the build in qa

            //set default image name space
            //change it to SANDBOX_IMAGE_SPACE if it's a feature branch
            env_image_namespace=NON_SANDBOX_IMAGE_SPACE

            //set branch type (master, develop,feature?)
            BRANCHES.each {key, value ->
                if ( value.branches.contains(env_git_branch_name) || env_git_branch_name.contains(key))
                    env_git_branch_type=key
            }
            if ( ! params.TARGET_ENVIRONMENT.contains("Choose") ){
                 KUBE_ENVS[params.TARGET_ENVIRONMENT].namespaces = params.OPENSHIFT_NAMESPACES.tokenize(",")
                 BRANCHES[env_git_branch_type].stages = params.TARGET_ENVIRONMENT.tokenize(",")
              }

            //override release name
            if ( ! params.RELEASE.contains("enter") )
                RELEASE_NAME=params.RELEASE
                // Release type - MAJOR/MINOR/PATCh
                env_release_type=params.RELEASE_TYPE

            // do we want to deploy a specific commit?
            if ( ! params.GIT_SHA.contains("enter") ) {
                env_step_name = "checkout non-latest"
                // if you choose a sha to deploy, shouldn't need to build again
                env_skip_build="true"
                env_current_git_commit=params.GIT_SHA

                //get ready to check out the commit for the sha
				    name_value=env_current_git_commit

                    //override earlier checked out source
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: "${name_value}"]],
                        doGenerateSubmoduleConfigurations: false,
                        extensions: [[$class: 'CloneOption', noTags: false, reference: '', shallow: true]],
                        submoduleCfg: [],
                        userRemoteConfigs: [[credentialsId: "${SSH_AGENT_GIT_ID}", url: "${env_git_repo_url}"]]
                    ])
                }

            // get the short version of commit
            env_current_git_commit="${env_current_git_commit[0..7]}"

            //include commit id in build name
            currentBuild.displayName = "#${BUILD_NUMBER} --- ${env_current_git_commit}"

            //set the values for the initial environment for deployment and tests
            setupForNextStage(g_stage_index,env_git_branch_type)
            slackNotification("pipeline","${APP_NAME}-${env_git_branch_name}: <${BUILD_URL}console|build #${BUILD_NUMBER}> started.","#439FE0","false")
          } //END script
        } //END container node
      } //END steps
    } //END stage
